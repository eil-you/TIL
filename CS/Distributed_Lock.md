# 분산 락 (Distributed Lock) 심화 정리

## 1. 분산 락이란?
여러 대의 서버(분산 환경)에서 공통된 자원에 접근할 때, **전체 서버를 통틀어 단 하나만 자원을 점유할 수 있도록** 보장하는 락 메커니즘입니다.

### 왜 필요한가?
*   **Java `synchronized`의 한계**: 단일 JVM 내에서만 유효합니다. 서버가 2대 이상이면 각각의 서버마다 한 명씩 진입이 가능해지므로 동시성 제어가 실패합니다.
*   **DB 락의 한계**: 비관적 락은 DB 커넥션을 점유한 채 대기하므로 트래픽이 몰리면 DB 커넥션 풀이 고갈될 위험이 큽니다.

---

## 2. 주요 구현 방식 비교

| 구분 | Redis (Redisson) | MySQL (Named Lock) | Zookeeper |
| :--- | :--- | :--- | :--- |
| **특징** | 인메모리 기반, Pub/Sub 활용 | `GET_LOCK()` 함수 활용 | 노드의 존재 여부 활용 |
| **성능** | 매우 빠름 | 보통 | 빠름 (안정적) |
| **복잡도** | 낮음 (라이브러리 발달) | 매우 낮음 (추가 인프라 X) | 높음 (인프라 필요) |
| **장점** | 효율적인 대기(Pub/Sub) | 별도 비용 없음 | 데이터 일관성 보장 강력 |

---

## 3. Redis를 이용한 구현 (가장 대중적)

### 1) Lettuce (Simple Setnx)
*   **방식**: "값이 없으면 세팅해라(SETNX)"라는 명령으로 락을 획득합니다.
*   **문제점**: 락을 획득하지 못하면 애플리케이션에서 "무한 루프(Spin Lock)"를 돌며 Redis에 계속 요청을 보냅니다. 이는 Redis에 큰 부하를 줍니다.

### 2) Redisson (Pub/Sub 방식) - ★ 추천
*   **방식**: 락이 해제될 때마다 대기 중인 다른 클라이언트에게 "이제 락 가져가세요!"라고 신호를 보냅니다(Pub/Sub).
*   **장점**:
    *   **부하 감소**: 요청을 계속 보내는 것이 아니라 신호가 올 때까지 대기하므로 CPU와 네트워크 부하가 훨씬 적습니다.
    *   **타임아웃 제공**: `leaseTime`을 설정해 무한 대기(Deadlock)를 방지할 수 있습니다.
    *   **재시도 로직**: 사용하기 쉬운 인터페이스로 락 획득 시도를 자동화해줍니다.

---

## 4. 분산 락 적용 시 주의사항

1.  **락의 범위 최소화**: 트랜잭션 전체를 락으로 감싸기보다, 실제 경쟁이 발생하는 로직만 최소한으로 감싸야 성능 저하를 막을 수 있습니다.
2.  **타임아웃 설정**: 서버 장애로 인해 락을 반납하지 못할 경우를 대비해, 자동으로 해제되는 시간을 반드시 설정해야 합니다.
3.  **트랜잭션과의 관계**:
    *   **주의**: 락은 트랜잭션이 **커밋된 이후에 해제**되어야 합니다.
    *   락을 먼저 풀고 트랜잭션이 아직 커밋 중일 때 다른 쓰레드가 락을 획득하면, 아직 반영되지 않은 구버전 데이터를 읽게 되어 정합성이 깨질 수 있습니다.

---

## 5. 실무 예시 (Spring + Redisson)
```java
public void reserve(Long roomId) {
    RLock lock = redissonClient.getLock("room_lock:" + roomId);
    try {
        // 1. 락 획득 시도 (최대 10초 대기, 락 점유 2초)
        boolean available = lock.tryLock(10, 2, TimeUnit.SECONDS);
        
        if (available) {
            // 2. 비즈니스 로직 실행 (예약 처리)
            reservationService.save(roomId);
        }
    } catch (InterruptedException e) {
        throw new RuntimeException("락 획득 중 인터럽트 발생");
    } finally {
        // 3. 반드시 락 해제
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

---

## 요약
분산 락은 **"여러 서버가 하나의 자원을 두고 싸울 때 쓰는 신호등"**입니다. 인프라 상황에 따라 다르지만, 보통 **성능과 편의성** 면에서 **Redis(Redisson)**가 가장 선호됩니다.
