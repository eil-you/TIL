# 데이터베이스 인덱스 심화: 부작용과 설계 전략

## Q1. 인덱스의 부작용과 모든 컬럼에 걸지 않는 이유

"모든 컬럼에 인덱스를 걸면 무조건 빨라지지 않을까?"라는 질문에 대한 답은 **"아니오"**입니다. 인덱스는 '추가적인 저장 공간'과 '쓰기 성능'을 맞바꾸는 트레이드오프(Trade-off) 관계이기 때문입니다.

### 1) 쓰기 성능(CUD) 저하
*   **INSERT**: 새로운 데이터를 삽입할 때마다 인덱스 B-Tree에 새로운 키 값을 추가하고 정렬을 유지해야 합니다.
*   **UPDATE**: 인덱스된 컬럼의 값이 변경될 경우, 기존 인덱스 값을 삭제(정확히는 마킹)하고 새로운 위치에 삽입하는 작업이 수반됩니다.
*   **DELETE**: 데이터를 삭제해도 인덱스에서는 값을 완전 삭제하지 않고 '사용하지 않음' 처리를 합니다. 이 때문에 실제 데이터는 적어도 인덱스 크기는 줄어들지 않아 성능이 점진적으로 저하될 수 있습니다.

### 2) 저장 공간 및 메모리 소모
*   인덱스는 별도의 데이터 구조를 생성하므로 물리적인 저장 공간을 차지합니다.
*   인덱스가 너무 많으면 DB의 **Buffer Cache(메모리)**를 인덱스가 차지하게 되어, 실제 데이터를 캐싱할 공간이 부족해지는 주객전도 현상이 발생할 수 있습니다.

### 3) 쿼리 옵티마이저의 혼선
*   사용 가능한 인덱스가 너무 많으면, DB 옵티마이저가 매번 최적의 실행 계획을 세우는 데 더 많은 시간을 소모하거나, 잘못된 인덱스를 선택할 확률이 높아집니다.

---

## Q2. 인덱스 선정 기준 및 '여기어때' 검색 최적화 전략

'여기어때'와 같은 숙소 예약 서비스에서 **"서울 강남구, 호텔, 10만원 이하, 평점 4.5 이상"**과 같은 검색을 처리한다고 가정해봅시다.

### 1) 카디널리티(Cardinality) 고려
*   **카디널리티가 높은(중복도가 낮은) 컬럼**을 인덱스 대상으로 삼습니다.
*   예: `숙소 ID` (매우 높음) > `숙소 이름` > `지역명` > `숙소 카테고리` > `예약 가능 여부` (매우 낮음)
*   성별이나 예약 가능 여부처럼 값의 종류가 몇 개 없는 컬럼은 인덱스를 걸어도 필터링 효과가 거의 없어 성능 향상을 기대하기 어렵습니다.

### 2) 복합 인덱스(Composite Index) 구성 및 순서
여러 필터를 동시에 검색할 때는 단일 인덱스 여러 개보다 **복합 인덱스** 하나가 훨씬 유리합니다. 이때 순서가 핵심입니다.

*   **Rule 1: 동등 조건(=)이 범위 조건(<, >, BETWEEN)보다 앞에 와야 합니다.**
    *   우선순위 1: `지역(region_id)`, `카테고리(category)` 등 (`=` 조건)
    *   우선순위 2: `가격(price)`, `평점(rating)` 등 (범위 조건)
*   **Rule 2: 카디널리티가 높은 컬럼을 앞에 둡니다.** (단, Rule 1이 더 우선됨)

**[추천 인덱스 설계]**
```sql
-- 지역별 숙소 검색 최적화
CREATE INDEX idx_accommodation_search ON accommodations (region_id, category, price, rating);
```
*   이렇게 설계하면 `region_id`와 `category`로 범위를 확 좁힌 뒤, 그 안에서 `price`와 `rating`으로 효율적인 스캔이 가능합니다.

### 3) 설계 시나리오: '여기어때' 검색 엔진
1.  **필수 필터 추출**: 사용자가 반드시 선택해야 하는 값(지역, 체크인/아웃 날짜)을 인덱스의 선행 컬럼으로 검토합니다.
2.  **커버링 인덱스(Covering Index)**: 만약 검색 결과 리스트에 표시할 정보가 `숙소명, 가격, 평점` 뿐이라면, 인덱스 자체에 이 컬럼들을 포함시켜 실제 데이터 페이지(Heap)에 접근하지 않고 인덱스만으로 쿼리를 해결하도록 설계합니다.
3.  **날짜 검색의 특수성**: 체크인/아웃 날짜는 보통 별도의 `예약(reservation)` 테이블과 조인이 필요하므로, `accommodation_id`와 날짜 컬럼을 묶은 인덱스를 예약 테이블에 생성하여 조인 성능을 높입니다.

---

## 요약
인덱스는 **"조회 빈도가 높고, CUD 빈도가 낮으며, 카디널리티가 높은 컬럼"**에 우선적으로 설계해야 하며, 복합 인덱스 시에는 **"동등 조건 -> 범위 조건"** 순으로 컬럼을 배치하는 것이 가장 중요합니다.
